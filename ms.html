<html>

<head>
    <title>File load</title>
</head>

<body>
    <input type="file" id="myFile">Load image</input>
    <br>
    <img id="myImage" style="border:1px" />
    <br>
    <script type="text/javascript" src="src/build/ms/main.js"></script>
    <script type="text/javascript" src="src/build/ms/mapScanner.js"></script>
    <script>
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext("2d");
        var img;
        var imageData;
        var cdata;
        var f = Module.cwrap('myimage', 'number', ['number', 'number', 'number'])

        function carray(arr) {
            // allocate the space
            var byteSize = 1;
            var offset = Module._malloc(arr.length * byteSize);
            Module.HEAPU8.set(arr, offset / byteSize);
            return {
                "data": Module.HEAPU8.subarray(offset / byteSize, offset / byteSize + arr.length),
                "offset": offset
            }
        }

        document.getElementById('myFile').onchange = function (evt) {
            var tgt = evt.target || window.event.srcElement,
                files = tgt.files;

            // FileReader support
            if (FileReader && files && files.length) {
                var fr = new FileReader();
                fr.onload = () => showImage(fr);
                fr.readAsDataURL(files[0]);
            }
        }

        function showImage(fileReader) {
            img = document.getElementById("myImage");
            img.onload = getImageData;
            img.src = fileReader.result;
        }

        function getImageData() {
            ctx.drawImage(img, 0, 0);
            imageData = ctx.getImageData(0, 0, img.width, img.height).data;
            console.log("image data:", imageData);
            cdata = carray(imageData);
            f(cdata.offset, img.width, img.height);
        }
    </script>
</body>

</html>